name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          g++ \
          libboost-all-dev \
          libgdal-dev \
          libgeotiff-dev \
          libproj-dev \
          libtiff-dev \
          zlib1g-dev \
          liblas-dev \
          liblas-c-dev \
          liblaszip-dev

    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release -j$(nproc)

    - name: Run Tests
      run: ./build/xyz2las_test

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: xyz2las-linux-amd64
        path: build/xyz2las

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: xyz2las-linux-amd64
        path: .

    - name: Make executable
      run: chmod +x xyz2las

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: xyz2las
        generate_release_notes: true
